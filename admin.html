<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jobs.SchoolHunt - Admin Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .loading-spinner { display: none; }
    .loading-spinner.active { display: block; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    function Login({ setToken }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
          const res = await fetch('https://jobsschoolhunt-backend.onrender.com/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (data.token) {
            localStorage.setItem('token', data.token);
            setToken(data.token);
          } else {
            setError(data.message || 'Login failed');
          }
        } catch (err) {
          setError('Unable to connect to the server');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
          <div className="bg-white p-6 sm:p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 className="text-xl sm:text-2xl font-bold mb-6 text-center">Admin Login</h2>
            {error && <p className="text-red-500 mb-4 text-center">{error}</p>}
            <form onSubmit={handleLogin}>
              <div className="mb-4">
                <label className="block text-gray-700">Username</label>
                <input
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
                  required
                />
              </div>
              <div className="mb-4">
                <label className="block text-gray-700">Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
                  required
                />
              </div>
              <button
                type="submit"
                className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 flex items-center justify-center"
                disabled={loading}
              >
                {loading ? (
                  <i className="fas fa-spinner loading-spinner active mr-2"></i>
                ) : (
                  'Login'
                )}
              </button>
            </form>
          </div>
        </div>
      );
    }

    function JobForm({ selectedJob, setSelectedJob, fetchJobs }) {
      const [formData, setFormData] = useState({
        title: '',
        postDate: '',
        applicationStartDate: '',
        applicationEndDate: '',
        extendedDate: '',
        category: '',
        location: '',
        salary: '',
        jobType: '',
        fees: { sc_st: 0, general: 0, ews: 0, obc: 0, bc: 0, female: 0 },
        article: '',
        link: '',
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      useEffect(() => {
        if (selectedJob) {
          setFormData({
            _id: selectedJob._id,
            title: selectedJob.title,
            postDate: selectedJob.postDate ? selectedJob.postDate.split('T')[0] : '',
            applicationStartDate: selectedJob.applicationStartDate ? selectedJob.applicationStartDate.split('T')[0] : '',
            applicationEndDate: selectedJob.applicationEndDate ? selectedJob.applicationEndDate.split('T')[0] : '',
            extendedDate: selectedJob.extendedDate ? selectedJob.extendedDate.split('T')[0] : '',
            category: selectedJob.category || '',
            location: selectedJob.location || '',
            salary: selectedJob.salary || '',
            jobType: selectedJob.jobType || '',
            fees: selectedJob.fees || { sc_st: 0, general: 0, ews: 0, obc: 0, bc: 0, female: 0 },
            article: selectedJob.article || '',
            link: selectedJob.link || '',
          });
        }
      }, [selectedJob]);

      const handleChange = (e) => {
        const { name, value } = e.target;
        if (name.startsWith('fees.')) {
          const feeType = name.split('.')[1];
          setFormData({
            ...formData,
            fees: { ...formData.fees, [feeType]: parseFloat(value) || 0 },
          });
        } else {
          setFormData({ ...formData, [name]: value });
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const res = await fetch('https://jobsschoolhunt-backend.onrender.com/api/admin/jobs', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`,
            },
            body: JSON.stringify(formData),
          });
          if (res.ok) {
            fetchJobs();
            setFormData({
              title: '',
              postDate: '',
              applicationStartDate: '',
              applicationEndDate: '',
              extendedDate: '',
              category: '',
              location: '',
              salary: '',
              jobType: '',
              fees: { sc_st: 0, general: 0, ews: 0, obc: 0, bc: 0, female: 0 },
              article: '',
              link: '',
            });
            setSelectedJob(null);
          } else {
            const data = await res.json();
            setError(data.message || 'Failed to save job');
          }
        } catch (err) {
          setError('Unable to connect to the server');
        } finally {
          setLoading(false);
        }
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-4">
          {error && <p className="text-red-500 text-center">{error}</p>}
          <div>
            <label className="block text-gray-700">Job Title</label>
            <input
              type="text"
              name="title"
              value={formData.title}
              onChange={handleChange}
              className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
              required
            />
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-gray-700">Post Date</label>
              <input
                type="date"
                name="postDate"
                value={formData.postDate}
                onChange={handleChange}
                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
                required
              />
            </div>
            <div>
              <label className="block text-gray-700">Application Start Date</label>
              <input
                type="date"
                name="applicationStartDate"
                value={formData.applicationStartDate}
                onChange={handleChange}
                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
                required
              />
            </div>
            <div>
              <label className="block text-gray-700">Application End Date</label>
              <input
                type="date"
                name="applicationEndDate"
                value={formData.applicationEndDate}
                onChange={handleChange}
                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
                required
              />
            </div>
            <div>
              <label className="block text-gray-700">Extended Date (Optional)</label>
              <input
                type="date"
                name="extendedDate"
                value={formData.extendedDate}
                onChange={handleChange}
                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
              />
            </div>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-gray-700">Category</label>
              <select
                name="category"
                value={formData.category}
                onChange={handleChange}
                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
              >
                <option value="">Select Category</option>
                <option value="Teaching">Teaching</option>
                <option value="Non-Teaching">Non-Teaching</option>
                <option value="Administration">Administration</option>
                <option value="IT">IT</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label className="block text-gray-700">Location</label>
              <input
                type="text"
                name="location"
                value={formData.location}
                onChange={handleChange}
                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
                placeholder="e.g., Delhi, Remote"
              />
            </div>
            <div>
              <label className="block text-gray-700">Salary</label>
              <input
                type="text"
                name="salary"
                value={formData.salary}
                onChange={handleChange}
                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
                placeholder="e.g., ₹50,000/month"
              />
            </div>
            <div>
              <label className="block text-gray-700">Job Type</label>
              <select
                name="jobType"
                value={formData.jobType}
                onChange={handleChange}
                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
              >
                <option value="">Select Job Type</option>
                <option value="Full-Time">Full-Time</option>
                <option value="Part-Time">Part-Time</option>
                <option value="Contract">Contract</option>
                <option value="Internship">Internship</option>
              </select>
            </div>
          </div>
          <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
            {['sc_st', 'general', 'ews', 'obc', 'bc', 'female'].map((category) => (
              <div key={category}>
                <label className="block text-gray-700">{category.toUpperCase().replace('_', '/')} Fee</label>
                <input
                  type="number"
                  name={`fees.${category}`}
                  value={formData.fees[category]}
                  onChange={handleChange}
                  className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
                  min="0"
                />
              </div>
            ))}
          </div>
          <div>
            <label className="block text-gray-700">Official Link (Optional)</label>
            <input
              type="url"
              name="link"
              value={formData.link}
              onChange={handleChange}
              className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
              placeholder="https://example.com"
            />
          </div>
          <div>
            <label className="block text-gray-700">Job Description</label>
            <textarea
              name="article"
              value={formData.article}
              onChange={handleChange}
              className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
              rows="6"
              placeholder="Write detailed job description here..."
            ></textarea>
          </div>
          <button
            type="submit"
            className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 flex items-center justify-center"
            disabled={loading}
          >
            {loading ? (
              <i className="fas fa-spinner loading-spinner active mr-2"></i>
            ) : (
              formData._id ? 'Update Job' : 'Post Job'
            )}
          </button>
        </form>
      );
    }

    function JobHistory({ jobId }) {
      const [history, setHistory] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      useEffect(() => {
        if (jobId) {
          setLoading(true);
          fetch(`https://jobsschoolhunt-backend.onrender.com/api/admin/jobs/${jobId}/history`, {
            headers  headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
          })
            .then((res) => res.json())
            .then((data) => {
              setHistory(data);
              setLoading(false);
            })
            .catch(() => {
              setError('Failed to load history');
              setLoading(false);
            });
        }
      }, [jobId]);

      return (
        <div className="mt-6">
          <h3 className="text-lg sm:text-xl font-bold">Update History</h3>
          {loading && <p className="text-center"><i className="fas fa-spinner loading-spinner active"></i></p>}
          {error && <p className="text-red-500 text-center">{error}</p>}
          {history.length === 0 && !loading && <p>No updates yet.</p>}
          <ul className="space-y-4">
            {history.map((entry) => (
              <li key={entry._id} className="border p-4 rounded">
                <p><strong>Updated At:</strong> {new Date(entry.updatedAt).toLocaleString()}</p>
                <p><strong>Changes:</strong></p>
                <ul className="list-disc pl-5">
                  {Object.entries(entry.changes).map(([key, change]) => (
                    <li key={key}>
                      {key}: {JSON.stringify(change.old)} → {JSON.stringify(change.new)}
                    </li>
                  ))}
                </ul>
              </li>
            ))}
          </ul>
        </div>
      );
    }

    function AdminPanel() {
      const [token, setToken] = useState(localStorage.getItem('token') || '');
      const [jobs, setJobs] = useState([]);
      const [selectedJob, setSelectedJob] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const fetchJobs = async () => {
        setLoading(true);
        try {
          const res = await fetch('https://jobsschoolhunt-backend.onrender.com/api/admin/jobs', {
            headers: { 'Authorization': `Bearer ${token}` },
          });
          if (!res.ok) throw new Error('Network response was not ok');
          const data = await res.json();
          setJobs(data);
        } catch (err) {
          setError('Failed to load jobs');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        if (token) fetchJobs();
      }, [token]);

      const handleLogout = () => {
        localStorage.removeItem('token');
        setToken('');
      };

      if (!token) return <Login setToken={setToken} />;

      return (
        <div className="min-h-screen bg-gray-100 p-4 sm:p-6">
          <div className="max-w-7xl mx-auto">
            <div className="flex flex-col sm:flex-row justify-between items-center mb-6">
              <h1 className="text-xl sm:text-3xl font-bold">Jobs.SchoolHunt Admin Panel</h1>
              <button onClick={handleLogout} className="bg-red-600 text-white p-2 rounded hover:bg-red-700 mt-2 sm:mt-0">
                Logout
              </button>
            </div>
            {error && <p className="text-red-500 text-center mb-4">{error}</p>}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white p-4 sm:p-6 rounded-lg shadow">
                <h2 className="text-lg sm:text-xl font-bold mb-4">{selectedJob ? 'Edit Job' : 'Post New Job'}</h2>
                <JobForm selectedJob={selectedJob} setSelectedJob={setSelectedJob} fetchJobs={fetchJobs} />
                {selectedJob && <JobHistory jobId={selectedJob._id} />}
              </div>
              <div className="bg-white p-4 sm:p-6 rounded-lg shadow">
                <h2 className="text-lg sm:text-xl font-bold mb-4">Existing Jobs</h2>
                {loading && <p className="text-center"><i className="fas fa-spinner loading-spinner active"></i></p>}
                <div className="space-y-4">
                  {jobs.sort((a, b) => new Date(b.postDate) - new Date(a.postDate)).map((job) => (
                    <div key={job._id} className="border p-4 rounded flex flex-col sm:flex-row justify-between items-start sm:items-center">
                      <div>
                        <h3 className="font-bold">{job.title}</h3>
                        <p>Category: {job.category || 'N/A'}</p>
                        <p>Location: {job.location || 'N/A'}</p>
                        <p>Posted on: {new Date(job.postDate).toLocaleDateString()}</p>
                      </div>
                      <button
                        onClick={() => setSelectedJob(job)}
                        className="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 mt-2 sm:mt-0"
                      >
                        Edit
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<AdminPanel />, document.getElementById('root'));
  </script>
</body>
</html>