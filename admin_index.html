<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jobs.SchoolHunt - Admin Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    function Login({ setToken }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');

      const handleLogin = async (e) => {
        e.preventDefault();
        try {
          const res = await fetch('https://jobsschoolhunt-backend.onrender.com/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (data.token) {
            localStorage.setItem('token', data.token);
            setToken(data.token);
          } else {
            setError(data.message);
          }
        } catch (err) {
          setError('Login failed');
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100">
          <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 className="text-2xl font-bold mb-6 text-center">Admin Login</h2>
            {error && <p className="text-red-500 mb-4">{error}</p>}
            <form onSubmit={handleLogin}>
              <div className="mb-4">
                <label className="block text-gray-700">Username</label>
                <input
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  className="w-full p-2 border rounded"
                  required
                />
              </div>
              <div className="mb-4">
                <label className="block text-gray-700">Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full p-2 border rounded"
                  required
                />
              </div>
              <button type="submit" className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
                Login
              </button>
            </form>
          </div>
        </div>
      );
    }

    function JobForm({ selectedJob, setSelectedJob, fetchJobs }) {
      const [formData, setFormData] = useState({
        title: '',
        postDate: '',
        applicationStartDate: '',
        applicationEndDate: '',
        extendedDate: '',
        fees: { sc_st: 0, general: 0, ews: 0, obc: 0, bc: 0, female: 0 },
        article: '',
        link: '',
      });

      useEffect(() => {
        if (selectedJob) {
          setFormData({
            _id: selectedJob._id,
            title: selectedJob.title,
            postDate: selectedJob.postDate ? selectedJob.postDate.split('T')[0] : '',
            applicationStartDate: selectedJob.applicationStartDate ? selectedJob.applicationStartDate.split('T')[0] : '',
            applicationEndDate: selectedJob.applicationEndDate ? selectedJob.applicationEndDate.split('T')[0] : '',
            extendedDate: selectedJob.extendedDate ? selectedJob.extendedDate.split('T')[0] : '',
            fees: selectedJob.fees,
            article: selectedJob.article,
            link: selectedJob.link,
          });
        }
      }, [selectedJob]);

      const handleChange = (e) => {
        const { name, value } = e.target;
        if (name.startsWith('fees.')) {
          const feeType = name.split('.')[1];
          setFormData({
            ...formData,
            fees: { ...formData.fees, [feeType]: parseFloat(value) || 0 },
          });
        } else {
          setFormData({ ...formData, [name]: value });
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        try {
          const res = await fetch('https://jobsschoolhunt-backend.onrender.com/api/admin/jobs', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`,
            },
            body: JSON.stringify(formData),
          });
          if (res.ok) {
            fetchJobs();
            setFormData({
              title: '',
              postDate: '',
              applicationStartDate: '',
              applicationEndDate: '',
              extendedDate: '',
              fees: { sc_st: 0, general: 0, ews: 0, obc: 0, bc: 0, female: 0 },
              article: '',
              link: '',
            });
            setSelectedJob(null);
          } else {
            alert('Failed to save job');
          }
        } catch (err) {
          alert('Error saving job');
        }
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-gray-700">Job Title</label>
            <input
              type="text"
              name="title"
              value={formData.title}
              onChange={handleChange}
              className="w-full p-2 border rounded"
              required
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-gray-700">Post Date</label>
              <input
                type="date"
                name="postDate"
                value={formData.postDate}
                onChange={handleChange}
                className="w-full p-2 border rounded"
                required
              />
            </div>
            <div>
              <label className="block text-gray-700">Application Start Date</label>
              <input
                type="date"
                name="applicationStartDate"
                value={formData.applicationStartDate}
                onChange={handleChange}
                className="w-full p-2 border rounded"
                required
              />
            </div>
            <div>
              <label className="block text-gray-700">Application End Date</label>
              <input
                type="date"
                name="applicationEndDate"
                value={formData.applicationEndDate}
                onChange={handleChange}
                className="w-full p-2 border rounded"
                required
              />
            </div>
            <div>
              <label className="block text-gray-700">Extended Date (Optional)</label>
              <input
                type="date"
                name="extendedDate"
                value={formData.extendedDate}
                onChange={handleChange}
                className="w-full p-2 border rounded"
              />
            </div>
          </div>
          <div className="grid grid-cols-3 gap-4">
            {['sc_st', 'general', 'ews', 'obc', 'bc', 'female'].map((category) => (
              <div key={category}>
                <label className="block text-gray-700">{category.toUpperCase().replace('_', '/')} Fee</label>
                <input
                  type="number"
                  name={`fees.${category}`}
                  value={formData.fees[category]}
                  onChange={handleChange}
                  className="w-full p-2 border rounded"
                  min="0"
                />
              </div>
            ))}
          </div>
          <div>
            <label className="block text-gray-700">Official Link (Optional)</label>
            <input
              type="url"
              name="link"
              value={formData.link}
              onChange={handleChange}
              className="w-full p-2 border rounded"
              placeholder="https://example.com"
            />
          </div>
          <div>
            <label className="block text-gray-700">Article</label>
            <textarea
              name="article"
              value={formData.article}
              onChange={handleChange}
              className="w-full p-2 border rounded"
              rows="6"
              placeholder="Write job-related article here..."
            ></textarea>
          </div>
          <button type="submit" className="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
            {formData._id ? 'Update Job' : 'Post Job'}
          </button>
        </form>
      );
    }

    function JobHistory({ jobId }) {
      const [history, setHistory] = useState([]);

      useEffect(() => {
        if (jobId) {
          fetch(`https://jobsschoolhunt-backend.onrender.com/api/admin/jobs/${jobId}/history`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
          })
            .then((res) => res.json())
            .then((data) => setHistory(data));
        }
      }, [jobId]);

      return (
        <div className="mt-6">
          <h3 className="text-xl font-bold">Update History</h3>
          {history.length === 0 ? (
            <p>No updates yet.</p>
          ) : (
            <ul className="space-y-4">
              {history.map((entry) => (
                <li key={entry._id} className="border p-4 rounded">
                  <p><strong>Updated At:</strong> {new Date(entry.updatedAt).toLocaleString()}</p>
                  <p><strong>Changes:</strong></p>
                  <ul className="list-disc pl-5">
                    {Object.entries(entry.changes).map(([key, change]) => (
                      <li key={key}>
                        {key}: {JSON.stringify(change.old)} → {JSON.stringify(change.new)}
                      </li>
                    ))}
                  </ul>
                </li>
              ))}
            </ul>
          )}
        </div>
      );
    }

    function AdminPanel() {
      const [token, setToken] = useState(localStorage.getItem('token') || '');
      const [jobs, setJobs] = useState([]);
      const [selectedJob, setSelectedJob] = useState(null);

      const fetchJobs = async () => {
        const res = await fetch('https://jobsschoolhunt-backend.onrender.com/api/admin/jobs', {
          headers: { 'Authorization': `Bearer ${token}` },
        });
        const data = await res.json();
        setJobs(data);
      };

      useEffect(() => {
        if (token) fetchJobs();
      }, [token]);

      const handleLogout = () => {
        localStorage.removeItem('token');
        setToken('');
      };

      if (!token) return <Login setToken={setToken} />;

      return (
        <div className="min-h-screen bg-gray-100 p-6">
          <div className="max-w-7xl mx-auto">
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold">Jobs.SchoolHunt Admin Panel</h1>
              <button onClick={handleLogout} className="bg-red-600 text-white p-2 rounded hover:bg-red-700">
                Logout
              </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-white p-6 rounded-lg shadow">
                <h2 className="text-xl font-bold mb-4">{selectedJob ? 'Edit Job' : 'Post New Job'}</h2>
                <JobForm selectedJob={selectedJob} setSelectedJob={setSelectedJob} fetchJobs={fetchJobs} />
                {selectedJob && <JobHistory jobId={selectedJob._id} />}
              </div>
              <div className="bg-white p-6 rounded-lg shadow">
                <h2 className="text-xl font-bold mb-4">Existing Jobs</h2>
                <div className="space-y-4">
                  {jobs.sort((a, b) => new Date(b.postDate) - new Date(a.postDate)).map((job) => (
                    <div key={job._id} className="border p-4 rounded flex justify-between items-center">
                      <div>
                        <h3 className="font-bold">{job.title}</h3>
                        <p>Posted on: {new Date(job.postDate).toLocaleDateString()}</p>
                        <p>End Date: {new Date(job.applicationEndDate).toLocaleDateString()}</p>
                        {job.extendedDate && (
                          <p>Extended Date: {new Date(job.extendedDate).toLocaleDateString()}</p>
                        )}
                      </div>
                      <button
                        onClick={() => setSelectedJob(job)}
                        className="bg-blue-600 text-white p-2 rounded hover:bg-blue-700"
                      >
                        Edit
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<AdminPanel />, document.getElementById('root'));
  </script>
</body>
</html>